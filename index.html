document.getElementById("add-btn").addEventListener("click", async () => {
  if (!currentUser) {
    alert("Please log in first!");
    return;
  }

  const location = prompt("Where do you play Hacky Sack?");
  if (!location) return;

  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*,video/*';

  fileInput.onchange = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    try {
      const coords = await getCoordinatesForLocation(location);
      const storageRef = ref(storage, `hacky-sack-spots/${Date.now()}_${file.name}`);
      const snapshot = await uploadBytes(storageRef, file);
      const url = await getDownloadURL(snapshot.ref);

      const marker = new mapboxgl.Marker().setLngLat(coords);

      const mediaTag = url.includes('.mp4')
        ? `<video controls src="${url}" style="width:200px"></video>`
        : `<img src="${url}" style="width:200px" />`;

      // Unique ID to avoid collision with other buttons
      const deleteId = `delete-${Date.now()}`;

      const popup = new mapboxgl.Popup().setHTML(`
        <strong>Uploaded by:</strong> ${currentUser.displayName}<br/>
        ${mediaTag}<br/>
        <button id="${deleteId}">Remove Pin</button>
      `);

      marker.setPopup(popup).addTo(map);

      // Wait for popup to open before attaching click
      map.once('popupopen', () => {
        document.getElementById(deleteId).onclick = () => {
          marker.remove();
        };
      });

      await addDoc(collection(db, "hackySpots"), {
        user: currentUser.displayName,
        fileUrl: url,
        coordinates: coords,
        timestamp: Date.now(),
        location
      });

    } catch (err) {
      console.error("Error uploading:", err);
      alert("Something went wrong! Try again.");
    }
  };
  fileInput.click();
});
